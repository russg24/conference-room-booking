name: Production Deployment

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to AWS EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          # The important changes are in the nohup line below
          script: |
            echo "ðŸ›‘ Stopping old services..."
            # We ignore errors (|| true) so the script doesn't crash if nothing is running
            pkill -f "app.py" || true
            pkill -f "http.server" || true
            
            echo "â¬‡ï¸ Pulling latest code..."
            cd conference-room-booking
            # Reset ensures no merge conflicts block the pull
            git reset --hard origin/main
            git pull origin main
            
            echo "ðŸš€ Restarting application..."
            chmod +x start.sh
            
            # THE MAGIC FIX:
            # 1. > deployment.log 2>&1  (Send all text to a log file, not SSH)
            # 2. < /dev/null            (Cut the input cord so it doesn't wait for user)
            # 3. &                      (Run in background)
            nohup ./start.sh > deployment.log 2>&1 < /dev/null &
            
            # Wait 1 second to make sure it started, then force exit
            sleep 1
            echo "âœ… Deployment Triggered. Exiting SSH session."
            exit